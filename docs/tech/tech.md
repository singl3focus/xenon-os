# Описание 

- Сборка .c файлов: /
```gcc -m32 -O0 -nostdlib -nostdinc -ffreestanding -fno-builtin -fno-stack-protector -nostartfiles -nodefaultlibs -c kmain.c -o kmain.o```

- Сборка загручика: /
```nasm -f elf32 loader.s```

- Сборка ядра: /
```ld -melf_i386 -T link.ld loader.o kmain.o -o kernel.elf```

- Сборка образа ОС: /
```genisoimage -R -b boot/grub/stage2_eltorito -no-emul-boot -boot-load-size 4 -A os -input-charset utf8 -quiet -boot-info-table -o os.iso iso```

- Запуск образа через Bochs (рекомендуется 3.0 и выше): /
```bochs```

## Основная часть

### IDT (Interrupt Descriptor Table)

***IDT*** - это таблица дескрипторов прерываний, используемая процессором для обработки событий. Она содержит информацию о:
- Обработчиках исключений (ошибки CPU)
- Аппаратных прерываниях (IRQ - Interrupt Request)
- Программных прерываниях (системные вызовы)

Когда происходит событие (например, ошибка деления или нажатие клавиши), процессор ищет соответствующий обработчик в IDT и передает управление ему.

#### Основные компоненты

1. Структуры данных
```c
struct idt_entry {
    uint16_t offset_low;   // Младшие 16 бит адреса обработчика
    uint16_t selector;     // Селектор сегмента кода в GDT
    uint8_t zero;          // Всегда 0
    uint8_t type_attr;     // Флаги типа и атрибутов
    uint16_t offset_high;  // Старшие 16 бит адреса обработчика
} __attribute__((packed));

struct idt_ptr {
    uint16_t limit;        // Размер IDT - 1
    uint32_t base;         // Базовый адрес IDT
} __attribute__((packed));
```

2. Функции

idt_set_gate() - Настраивает отдельный шлюз в IDT:

- ```num``` - номер прерывания (0-255)
- ```offset``` - адрес обработчика (функции isrX/irqX)
- ```sel``` - селектор сегмента кода (0x08 - стандартный сегмент ядра)
- ```flags``` - атрибуты шлюза (0x8E = 32-битное прерывание, уровень привилегий 0)

init_idt() - инициализирует всю IDT.

- Настраивает указатель на таблицу (idtp)
- Регистрирует обработчики исключений (0-31)
- Регистрирует обработчики IRQ (32-47)
- Загружает IDT командой lidt

#### Ключевые понятия

1. Исключения (0-31) - ошибки процессора (например, деление на ноль)

2. IRQ (32-47) - аппаратные прерывания от устройств

3. Селектор (0x08) - указывает на дескриптор сегмента кода в GDT

4. Флаги (0x8E) - битовая маска:
    - P (Present) = 1
    - DPL (Privilege Level) = 00 (уровень ядра)
    - Type = 0xE (32-битный шлюз прерывания)

#### Как работает обработка прерывания
1. Процессор получает номер прерывания (N)
2. Находит N-й дескриптор в IDT
3. Проверяет права доступа
4. Сохраняет контекст
5. Переходит по адресу offset_high:offset_low
6. Выполняет обработчик (isrX или irqX)
7. Возвращает управление (команда iret)

#### Пример добавления обработчика
Чтобы добавить новое исключение:

1. Создайте обработчик в isr.c:
```c
void isr14(...) { ... }  // Обработчик Page Fault
```

2. Зарегистрируйте его в init_idt():
```c
idt_set_gate(14, (uint32_t)&isr14, 0x08, 0x8E);
```
